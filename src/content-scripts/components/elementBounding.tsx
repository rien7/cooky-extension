import { useRef } from 'react'
import { SendType } from '../../utils/sendType'
import type { ParagraphDataType } from '../App'
import type { ElementBoundingType } from '../hooks/useElementBounding'
import { generateParagraphId, sendMessage } from '../util/sendMessages'

export default function ElementBounding(props: {
  element: Element
  bounding: ElementBoundingType
  boundingRef: React.MutableRefObject<HTMLDivElement | null>
  elementRef: React.MutableRefObject<HTMLElement | undefined>
  fixed: boolean
  setFixed: React.Dispatch<React.SetStateAction<boolean>>
  _paragraphData: React.MutableRefObject<ParagraphDataType[]>
  children: React.ReactNode[]
}) {
  const { element, bounding, boundingRef, elementRef, fixed, setFixed, _paragraphData } = props
  const bodyBounding = document.body.getBoundingClientRect()
  const directTranslate = useRef(false)
  const isBlock = element.classList.contains('cooky-selection-paragraph')

  let pointer = 'cursor-pointer'

  if (isBlock && !directTranslate.current)
    pointer = 'cursor-not-allowed'
  else if (fixed)
    pointer = 'cursor-default'

  function handleHighlightClick() {
    const classList = element.classList
    if (classList.contains('cooky-selection-paragraph'))
      return
    setFixed(true)
    if (!classList.contains('cooky-selecting-paragraph'))
      element.classList.add('cooky-selecting-paragraph')
    elementRef.current = element as HTMLElement

    // disable <a> tag
    const aTags = element.querySelectorAll('a')
    aTags.forEach((aTag) => {
      const href = aTag.getAttribute('href')
      if (href) {
        aTag.removeAttribute('href')
        aTag.setAttribute('disabled-href', href)
      }
    })
  }

  function handleSendMessageClick() {
    directTranslate.current = true
    const classList = element.classList
    if (classList.contains('cooky-selection-paragraph'))
      return
    setFixed(true)
    //  if (!classList.contains('cooky-selecting-paragraph'))
    //    element.classList.add('cooky-selecting-paragraph')
    elementRef.current = element as HTMLElement
    const paragraphData = _paragraphData.current
    const paragraphId = generateParagraphId(element, paragraphData)
    const pd: ParagraphDataType = {
      id: paragraphId,
      element: element as HTMLElement,
      current: true,
      position: bounding,
      text: element.textContent || '',
      selections: [],
      selectionsTranslation: [],
      chatHistory: [],
    }
    paragraphData.push(pd)
    if (!classList.contains('cooky-selection-paragraph'))
      element.classList.add('cooky-selection-paragraph', `paragraph-${paragraphId}`)
    sendMessage(pd, setFixed, SendType.TRANSLATE_ONLY)
  }

  return (
    <>
    { !directTranslate.current
      && <div ref={boundingRef}
        className={`absolute z-50 ${pointer} overflow-hidden rounded-lg bg-transparent transition-all duration-300`}
        style={{
          left: bounding.left + bounding.scrollX - 10 - bodyBounding.left,
          top: bounding.top + bounding.scrollY - 10,
          width: bounding.width + 20,
          height: bounding.height + 20,
        }}>
          { isBlock
            && <div className='group absolute left-0 top-0 h-full w-full bg-red-400/40'>
                <BlockSvg />
              </div>
          }
          {!fixed && !isBlock
            && <>
              <div className='group absolute left-0 h-full w-3/4 bg-orange-400/20' onClick={handleHighlightClick}>
                <HighlightSvg />
              </div>
              <div className='group absolute right-0 h-full w-1/4 cursor-e-resize bg-amber-400/20' onClick={handleSendMessageClick}>
                <SendMessageSvg />
              </div>
            </>}
          {props.children}
      </div>
    }
    </>
  )
}

function HighlightSvg() {
  return (
    <>
      <svg className='absolute left-1/2 top-1/2 h-1/2 max-h-[5rem] min-h-[2.5rem] max-w-[80%] -translate-x-1/2 -translate-y-1/2 opacity-0 transition group-hover:opacity-100'
        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <g clipPath="url(#clip0_1_6)">
          <path fill="#FED7AA" stroke="#FED7AA"
            d="M18.8089 3.45158C17.9701 3.30925 16.7094 3.26243 15.5 3.25H9.94358C8.10582 3.24998 6.65019 3.24997 5.51098 3.40314C4.33856 3.56076 3.38961 3.89288 2.64124 4.64124C1.89288 5.38961 1.56076 6.33856 1.40314 7.51098C1.24997 8.65019 1.24998 10.1058 1.25 11.9436V12.0564C1.24998 13.8942 1.24997 15.3498 1.40314 16.489C1.56076 17.6614 1.89288 18.6104 2.64124 19.3588C3.38961 20.1071 4.33856 20.4392 5.51098 20.5969C6.65018 20.75 8.10585 20.75 9.94359 20.75H15.5C16.7094 20.7376 17.9701 20.6908 18.8089 20.5484C19.8369 20.374 20.6807 20.0368 21.3588 19.3588C22.1071 18.6104 22.4392 17.6614 22.5969 16.489C22.75 15.3498 22.75 13.8942 22.75 12.0564V11.9435C22.75 10.1058 22.75 8.65017 22.5969 7.51098C22.4392 6.33856 22.1071 5.38961 21.3588 4.64124C20.6807 3.96316 19.8369 3.626 18.8089 3.45158Z"/>
          <path fillRule="evenodd" clipRule="evenodd" fill='#fb923c' stroke='#fb923c'
            d="M15 1.25C15.4142 1.25 15.75 1.58579 15.75 2V3.2555C16.9594 3.26793 17.9701 3.30925 18.8089 3.45158C19.8369 3.626 20.6807 3.96316 21.3588 4.64124C22.1071 5.38961 22.4392 6.33856 22.5969 7.51098C22.75 8.65018 22.75 10.1058 22.75 11.9435V12.0564C22.75 13.8942 22.75 15.3498 22.5969 16.489C22.4392 17.6614 22.1071 18.6104 21.3588 19.3588C20.6807 20.0368 19.8369 20.374 18.8089 20.5484C17.9701 20.6908 16.9594 20.7321 15.75 20.7445V22C15.75 22.4142 15.4142 22.75 15 22.75C14.5858 22.75 14.25 22.4142 14.25 22V2C14.25 1.58579 14.5858 1.25 15 1.25ZM15.75 19.2443V4.75569C16.9362 4.76835 17.8391 4.80847 18.558 4.93044C19.3998 5.07329 19.9131 5.31689 20.2981 5.7019C20.7213 6.12511 20.975 6.70476 21.1102 7.71085C21.2484 8.73851 21.25 10.0932 21.25 12C21.25 13.9068 21.2484 15.2615 21.1102 16.2892C20.975 17.2952 20.7213 17.8749 20.2981 18.2981C19.9131 18.6831 19.3998 18.9267 18.558 19.0696C17.8391 19.1915 16.9362 19.2316 15.75 19.2443Z"/>
          <path fill='#fb923c' stroke='#fb923c'
            d="M9.94358 3.25H12C12.4142 3.25 12.75 3.58579 12.75 4C12.75 4.41421 12.4142 4.75 12 4.75H10C8.09318 4.75 6.73851 4.75159 5.71085 4.88976C4.70476 5.02502 4.12511 5.27869 3.7019 5.7019C3.27869 6.12511 3.02503 6.70476 2.88976 7.71085C2.75159 8.73851 2.75 10.0932 2.75 12C2.75 13.9068 2.75159 15.2615 2.88976 16.2892C3.02503 17.2952 3.27869 17.8749 3.7019 18.2981C4.12511 18.7213 4.70476 18.975 5.71085 19.1102C6.73851 19.2484 8.09318 19.25 10 19.25H12C12.4142 19.25 12.75 19.5858 12.75 20C12.75 20.4142 12.4142 20.75 12 20.75H9.94359C8.10585 20.75 6.65018 20.75 5.51098 20.5969C4.33856 20.4392 3.38961 20.1071 2.64124 19.3588C1.89288 18.6104 1.56076 17.6614 1.40314 16.489C1.24997 15.3498 1.24998 13.8942 1.25 12.0564V11.9436C1.24998 10.1058 1.24997 8.65019 1.40314 7.51098C1.56076 6.33856 1.89288 5.38961 2.64124 4.64124C3.38961 3.89288 4.33856 3.56076 5.51098 3.40314C6.65019 3.24997 8.10582 3.24998 9.94358 3.25Z"/>
          <path fill='#fb923c' stroke='#fb923c'
            d="M6.81782 7.78733C7.11779 7.74992 7.48429 7.74996 7.88383 7.75H10.1162C10.5157 7.74996 10.8822 7.74992 11.1822 7.78733C11.5109 7.82833 11.8612 7.9242 12.1624 8.19187C12.2138 8.23753 12.2625 8.28618 12.3081 8.33756C12.5758 8.63878 12.6717 8.98915 12.7127 9.31782C12.7501 9.61779 12.7501 9.98428 12.75 10.3838V10.425C12.75 10.8392 12.4142 11.175 12 11.175C11.5858 11.175 11.25 10.8392 11.25 10.425C11.25 9.97047 11.2486 9.69931 11.2242 9.50348C11.1998 9.30765 10.9965 9.2758 10.9965 9.2758C10.8007 9.25137 10.5295 9.25001 10.075 9.25001H9.75001V14.75H11C11.4142 14.75 11.75 15.0858 11.75 15.5C11.75 15.9142 11.4142 16.25 11 16.25H7.00001C6.58579 16.25 6.25001 15.9142 6.25001 15.5C6.25001 15.0858 6.58579 14.75 7.00001 14.75H8.25001V9.25001H7.92501C7.47047 9.25001 7.19931 9.25137 7.00348 9.2758C7.00348 9.2758 6.80023 9.30765 6.7758 9.50348C6.75138 9.69931 6.75001 9.97047 6.75001 10.425C6.75001 10.8392 6.41422 11.175 6.00001 11.175C5.58579 11.175 5.25001 10.8392 5.25001 10.425L5.25 10.3838C5.24996 9.98428 5.24992 9.61779 5.28733 9.31782C5.32833 8.98915 5.4242 8.63878 5.69187 8.33756C5.73753 8.28618 5.78618 8.23753 5.83757 8.19187C6.13878 7.9242 6.48915 7.82833 6.81782 7.78733Z"/>
        </g>
        <defs>
          <clipPath id="clip0_1_6">
            <rect width="24" height="24" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </>
  )
}

function SendMessageSvg() {
  return (
    <>
      <svg className="absolute left-1/2 top-1/2 h-1/2 max-h-[5rem] min-h-[2.5rem] max-w-[80%] -translate-x-1/2 -translate-y-1/2 opacity-0 transition group-hover:opacity-100"
        viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path fillRule="evenodd" clipRule="evenodd" fill="#FDE68A" stroke="#FDE68A"
          d="M17.8746 2.11797C19.1768 1.88632 20.3496 1.93941 21.2051 2.79491C22.0606 3.65041 22.1137 4.82322 21.882 6.12542C21.6518 7.41975 21.0903 9.10415 20.3794 11.2367L18.6745 16.3515C18.096 18.0869 17.6465 19.4354 17.232 20.41C16.8322 21.35 16.3882 22.1457 15.7139 22.5377C14.6537 23.1541 13.3442 23.1541 12.284 22.5377C11.6096 22.1457 11.1657 21.35 10.7658 20.41C10.3513 19.4354 9.90184 18.0869 9.32338 16.3515L9.31105 16.3145C9.10838 15.7065 9.04661 15.5416 8.95909 15.4109C8.86114 15.2646 8.73545 15.1389 8.58913 15.0409C8.4584 14.9534 8.29348 14.8916 7.68549 14.689L7.64845 14.6766C5.91306 14.0982 4.56463 13.6487 3.59005 13.2342C2.64996 12.8343 1.85431 12.3904 1.46228 11.716C0.845906 10.6558 0.845907 9.34634 1.46228 8.28611C1.85431 7.61177 2.64996 7.16781 3.59005 6.76797C4.56464 6.35345 5.91309 5.90397 7.64852 5.3255L12.7633 3.62057C14.8959 2.9097 16.5803 2.34822 17.8746 2.11797Z" />
        <path fillRule="evenodd" clipRule="evenodd" fill='#fbbf24' stroke='#fbbf24'
          d="M18.1437 3.63083C16.9737 3.83896 15.3964 4.36262 13.1827 5.10051L8.17141 6.77094C6.39139 7.36428 5.1021 7.79468 4.19146 8.182C3.23939 8.58693 2.90071 8.86919 2.79071 9.0584C2.45191 9.64118 2.45191 10.361 2.79071 10.9437C2.90071 11.1329 3.23939 11.4152 4.19146 11.8201C5.1021 12.2075 6.39139 12.6379 8.17141 13.2312C8.19952 13.2406 8.22727 13.2498 8.25468 13.2589C8.74086 13.4206 9.11881 13.5464 9.44395 13.764C9.75719 13.9737 10.0263 14.2428 10.236 14.5561C10.4536 14.8812 10.5794 15.2592 10.7411 15.7453C10.7502 15.7727 10.7594 15.8005 10.7688 15.8286C11.3621 17.6086 11.7925 18.8979 12.1799 19.8085C12.5848 20.7606 12.867 21.0993 13.0563 21.2093C13.639 21.5481 14.3588 21.5481 14.9416 21.2093C15.1308 21.0993 15.4131 20.7606 15.818 19.8085C16.2053 18.8979 16.6357 17.6086 17.2291 15.8286L18.8995 10.8173C19.6374 8.60363 20.161 7.02627 20.3692 5.85629C20.5783 4.68074 20.4185 4.1814 20.1185 3.88146C19.8186 3.58152 19.3193 3.42171 18.1437 3.63083ZM17.8746 2.11797C19.1768 1.88632 20.3496 1.93941 21.2051 2.79491C22.0606 3.65041 22.1137 4.82322 21.882 6.12542C21.6518 7.41975 21.0903 9.10415 20.3794 11.2367L18.6745 16.3515C18.096 18.0869 17.6465 19.4354 17.232 20.41C16.8322 21.35 16.3882 22.1457 15.7139 22.5377C14.6537 23.1541 13.3442 23.1541 12.284 22.5377C11.6096 22.1457 11.1657 21.35 10.7658 20.41C10.3513 19.4354 9.90184 18.0869 9.32338 16.3515L9.31105 16.3145C9.10838 15.7065 9.04661 15.5416 8.95909 15.4109C8.86114 15.2646 8.73545 15.1389 8.58913 15.0409C8.4584 14.9534 8.29348 14.8916 7.68549 14.689L7.64845 14.6766C5.91306 14.0982 4.56463 13.6487 3.59005 13.2342C2.64996 12.8343 1.85431 12.3904 1.46228 11.716C0.845906 10.6558 0.845907 9.34634 1.46228 8.28611C1.85431 7.61177 2.64996 7.16781 3.59005 6.76797C4.56464 6.35345 5.91309 5.90397 7.64852 5.3255L12.7633 3.62057C14.8959 2.9097 16.5803 2.34822 17.8746 2.11797ZM17.6807 6.32532C17.9791 6.62702 17.9764 7.11348 17.6747 7.41185L13.5771 11.4643C13.2754 11.7627 12.7889 11.76 12.4905 11.4583C12.1921 11.1566 12.1948 10.6701 12.4965 10.3718L16.5942 6.3193C16.8959 6.02092 17.3823 6.02362 17.6807 6.32532Z"/>
      </svg>
    </>
  )
}

function BlockSvg() {
  return (
    <>
      <svg className='absolute left-1/2 top-1/2 h-1/2 max-h-[5rem] min-h-[2.5rem] max-w-[80%] -translate-x-1/2 -translate-y-1/2 opacity-0 transition group-hover:opacity-100'
        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <g clipPath="url(#clip0_9_6)">
          <path fillRule="evenodd" clipRule="evenodd" fill="#FECACA" stroke="#FECACA"
            d="M10.7064 1.25004C9.61863 1.24952 8.86268 1.24916 8.1713 1.53554C7.47993 1.82192 6.94564 2.35671 6.17684 3.12625L3.12625 6.17684C2.35671 6.94565 1.82192 7.47993 1.53554 8.1713C1.24916 8.86268 1.24952 9.61863 1.25004 10.7064V13.2938C1.24952 14.3815 1.24916 15.1375 1.53554 15.8289C1.82192 16.5202 2.35671 17.0545 3.12624 17.8233L6.17683 20.8739C6.94564 21.6435 7.47992 22.1783 8.1713 22.4646C8.86268 22.751 9.61863 22.7507 10.7064 22.7501H13.2938C14.3815 22.7507 15.1375 22.751 15.8289 22.4646C16.5202 22.1783 17.0545 21.6435 17.8233 20.874L20.8739 17.8233C21.6435 17.0545 22.1783 16.5202 22.4646 15.8289C22.751 15.1375 22.7507 14.3815 22.7501 13.2938V10.7064C22.7507 9.61863 22.751 8.86268 22.4646 8.1713C22.1783 7.47993 21.6435 6.94564 20.8739 6.17684L17.8233 3.12624C17.0545 2.35671 16.5202 1.82192 15.8289 1.53554C15.1375 1.24916 14.3815 1.24952 13.2938 1.25004H10.7064Z" />
          <path fillRule="evenodd" clipRule="evenodd" fill="#F87171" stroke="#F87171"
            d="M10.7064 1.25004C9.61863 1.24952 8.86268 1.24916 8.1713 1.53554C7.47993 1.82192 6.94564 2.35671 6.17684 3.12625L3.12625 6.17684C2.35671 6.94565 1.82192 7.47993 1.53554 8.1713C1.24916 8.86268 1.24952 9.61863 1.25004 10.7064V13.2938C1.24952 14.3815 1.24916 15.1375 1.53554 15.8289C1.82192 16.5202 2.35671 17.0545 3.12624 17.8233L6.17683 20.8739C6.94564 21.6435 7.47992 22.1783 8.1713 22.4646C8.86268 22.751 9.61863 22.7507 10.7064 22.7501H13.2938C14.3815 22.7507 15.1375 22.751 15.8289 22.4646C16.5202 22.1783 17.0545 21.6435 17.8233 20.874L20.8739 17.8233C21.6435 17.0545 22.1783 16.5202 22.4646 15.8289C22.751 15.1375 22.7507 14.3815 22.7501 13.2938V10.7064C22.7507 9.61863 22.751 8.86268 22.4646 8.1713C22.1783 7.47993 21.6435 6.94564 20.8739 6.17684L17.8233 3.12624C17.0545 2.35671 16.5202 1.82192 15.8289 1.53554C15.1375 1.24916 14.3815 1.24952 13.2938 1.25004H10.7064ZM8.74533 2.92136C9.12676 2.76336 9.56156 2.75009 10.849 2.75009H13.1512C14.4386 2.75009 14.8734 2.76336 15.2549 2.92136C15.6363 3.07936 15.9531 3.37742 16.8635 4.28778L17.7576 5.18191L5.1818 17.7575L4.28778 16.8635C3.37742 15.9531 3.07936 15.6363 2.92136 15.2548C2.76336 14.8734 2.75009 14.4386 2.75009 13.1512V10.849C2.75009 9.56156 2.76336 9.12676 2.92136 8.74533C3.07936 8.36389 3.37742 8.04706 4.28778 7.1367L7.1367 4.28778C8.04706 3.37742 8.36389 3.07936 8.74533 2.92136ZM6.24246 18.8182L7.1367 19.7124C8.04706 20.6228 8.36389 20.9208 8.74533 21.0788C9.12676 21.2368 9.56156 21.2501 10.849 21.2501H13.1512C14.4386 21.2501 14.8734 21.2368 15.2549 21.0788C15.6363 20.9208 15.9531 20.6228 16.8635 19.7124L19.7124 16.8635C20.6228 15.9531 20.9208 15.6363 21.0788 15.2548C21.2368 14.8734 21.2501 14.4386 21.2501 13.1512V10.849C21.2501 9.56156 21.2368 9.12676 21.0788 8.74533C20.9208 8.36389 20.6228 8.04706 19.7124 7.1367L18.8183 6.24257L6.24246 18.8182Z" />
        </g>
        <defs>
          <clipPath id="clip0_9_6">
            <rect width="24" height="24" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </>
  )
}
